<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  margin: 0;
  font: 10pt sans-serif;
}

a:link,
a:visited {
  color: steelblue;
}

path {
  fill: none;
  stroke: red;
  stroke-linejoin: round;
  stroke-width: 1px;
}

.tooltip {
  font-size: 10pt;
  position: absolute;
  background-color: #fff;
  border: 1px solid silver;
  padding: .5em;
  max-width: 200px;
  pointer-events: none;
  z-Index: 1000;
}

hr {
  border: 0;
  border-bottom: 1px solid silver;
  padding: 0;
  margin: 0;
  margin-top: 3px;
  margin-bottom: 3px;
}

.slidertimes {
  font-size: 9pt;
  position: relative;
  left: -15px;
  top: 4px;
}
.slidertimes span {
  text-align: center;
  display: block;
  position: absolute;
  color: gray;
}

#timeaxis {
  display: block;
  font-size: 9pt;
  margin-bottom: 1.5em;
}

#timeval {
  font-weight: bold;
  padding-left: 5px;
  padding-right: 5px;
}

#playbutton {
  color: silver;
  padding-left: 5px;

}

.label {
  font-family: "Helvetica Neue", Helvetica, Arial, Sans-Serif;
  font-weight: 400;
  font-size: 13pt;
  opacity: .5;
}

#filters {

}

.typefilter {
  color: gray;
  padding-right: 1em;
}
.typename {
  color: black;
  text-decoration: underline;
  padding: 2px;
}

.type_locked {
  border: 1px solid black;
}

#options {
  margin: 0 auto;
  width: 90%;
}

.footer {
  font-size: .8em;
  background-color: #fff;
  border: 1px #959595 dashed;
  border-bottom: none;
  position: absolute;
  bottom: 0;
  padding: 6px;
}

/* Map Features */

.company-circ {
  fill: #1f77b4;
  stroke: #000;
  stroke-opacity: .5;
  stroke-width: 1px;
  fill-opacity: .7;
}

.superfund-circ {
  fill: #ff7f0e;
  stroke: #000;
  stroke-opacity: .5;
  stroke-width: 1px;
  fill-opacity: .6;
}

.annexations { fill: blue; opacity: .5; }

.openspace { fill: green; opacity: .5; }

</style>

<script src="lib/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
<script src="lib/topojson.v1.min.js"></script>
<link href="lib/jquery-ui-1.10.4.custom.css" rel="stylesheet">
<script src="lib/jquery-1.10.2.js"></script>
<script src="lib/jquery-ui-1.10.4.custom.js"></script>
<script src="lib/queue.v1.min.js"></script>

<body>

<script>

var width = Math.max(960, window.innerWidth),
    height = Math.max(500, window.innerHeight - 150);

var lastYear = 2000;

var tile = d3.geo.tile()
    .size([width, height]);

var projection = d3.geo.mercator()
    .scale((1 << 20) / 2 / Math.PI)
    .translate([width / 2, height / 2]);

var center = projection([-122.0375, 37.3711]);

var path = d3.geo.path()
    .projection(projection);

var zoom = d3.behavior.zoom()
    .scale(projection.scale() * 2 * Math.PI)
    .scaleExtent([1 << 20, 1 << 26])
    .translate([width - center[0], height - center[1]])
    .on("zoom", zoomed);

// Adjust the projection on the computed center
// so it uses the zoom behavior's translate & scale
projection
    .scale(1 / 2 / Math.PI)
    .translate([0, 0]);

var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var loading = svg.append("text").attr({x:500,y:250}).text("Loading...").style("font-size", "26px");

var raster = svg.append("g");
var vector = svg.append("path");

queue()
    .defer(d3.csv, "data/SV-companies.csv")
    .defer(d3.csv, "data/ca_superfund.csv")
    .defer(d3.json, "data/openspace_santaclara.json")
    .await(ready);

function ready(error, sites, ca_superfund, openspace) {

  // would something like this work?
  // d3.csv("file.csv").filterCompanies();
  loading.remove();

  svg.call(zoom);

  var superfundsG = svg.append("g")
      .attr("id", "superfundG")
      .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

  var superfund_sites = superfundsG.selectAll(".superfunds")
    .data(ca_superfund)
  .enter()
    .append("g")
    .attr("transform", function (d) {
        return "translate(" + projection([d.LONGITUDE, d.LATITUDE]) + ")scale(" + projection.scale() + ")"
    })
    .on("mouseover", function(d,i) {
      tooltip.transition().duration(200).style("opacity", .8);
      tooltip.html("<br><strong>SUPERFUND SITE</strong> <br>" + "<strong>Company</strong>: " + d.NAME.toTitleCase() +
              (d.STATUSDATE?"<br>" + "<strong>Date added</strong>: "+d.STATUSDATE:"") + "<br>" +
              "<strong>Address</strong>: " + d.ADDRESS.toTitleCase() + "<br>" +
              (d.HRS_SCORE?"<br><hr><br><strong>HRS score</strong>: "+d.HRS_SCORE:"") +
              (d.EPA_ID?"<br><strong>EPA ID</strong>: "+d.EPA_ID:"")
              )
    })
    .on("mouseout", function(d,i) {
      tooltip.transition().duration(500).style("opacity", 0);
    });

  superfund_sites
    .append("circle")
    .attr("r", 60)
    .attr("class", "superfund-circ");

  var companiesG = svg.append("g")
      .attr("id", "companiesG")
      .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

  var companyPoints = companiesG.selectAll(".companies")
      .data(sites)
    .enter()
      .append("g")
      .attr("transform", function (d) {
          return "translate(" + projection([d.longitude, d.latitude]) + ")scale(" + projection.scale() + ")"
      })
      .on("mouseover", function(d,i) {
        tooltip.transition().duration(200).style("opacity", .8);
        tooltip.html("<br><strong>" + d.company.toTitleCase() + "</strong>" +
                (d.date_founded?"<br>" + "Founded: "+d.date_founded:"") + "<br>" +
                "Address: " + d.address.toTitleCase() + "<br>" +
                (d.description?"<hr>"+d.description:""))
      })
      .on("mouseout", function(d,i) {
        tooltip.transition().duration(500).style("opacity", 0);
      });

  companyPoints
      .append("circle")
      .attr("r", 18 / zoom.scale())
      .attr("class", "company-circ");

  // var openspaceG = svg.append("g")
  //   .attr("id", "openspaceG")
  //   .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

  // var openspaceArea = openspaceG.selectAll(".openspace")
  //   .data(topojson.feature(openspace, openspace.objects.units_sc).features)
  // .enter()
  //   .append("g")
  //   .attr("class", "openspace")
  //   .attr("transform", "translate(" + projection.translate() + ")scale(" + projection.scale() + ")");

  zoomed();

};

function zoomed() {
    var tiles = tile
        .scale(zoom.scale())
        .translate(zoom.translate())
        ();

    vector
        .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")")
        .style("stroke-width", 1 / zoom.scale());

    d3.select("#companiesG")
        .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

    d3.selectAll(".company-circ")
        .attr("r", 18 / zoom.scale())
        .style("stroke-width", 1 / zoom.scale());

    d3.select("#superfundG")
      .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

    d3.selectAll(".superfund-circ")
      .attr("r", 60 / zoom.scale())
      .style("stroke-width", 1 / zoom.scale());

    // openspace.attr("d", path);

    var image = raster
        .attr("transform", "scale(" + tiles.scale + ")translate(" + tiles.translate + ")")
        .selectAll("image")
        .data(tiles, function (d) {
            return d;
        });

    image.exit()
        .remove();

    image.enter().append("image")
        .attr("xlink:href", function(d) { return "http://" + ["a", "b", "c", "d"][Math.random() * 4 | 0] + ".tiles.mapbox.com/v3/hepplerj.i2kd8l64/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
        .attr("width", 1)
        .attr("height", 1)
        .attr("x", function (d) {
            return d[0];
        })
        .attr("y", function (d) {
            return d[1];
        });
}

var playinterval = 200;
var playid;
var playing = false;

$(function() {

    $( "#slider" ).slider({
      min: 1940,
      max: lastYear,
      value: 1940,
      step: 1,
      slide: function( event, ui ) { filterValues(ui.value); },
    });
    var sliderTimes = [1940,1950,1960,1970,1980,1990,2000];
    for(i in sliderTimes) {
      switch(+i) {
      case 0:
        var timePer = 0;
        var timeDir = "left";
      break;
      case (sliderTimes.length-1):
        var timePer = -3;
        var timeDir = "right";
      break;
      default:
        var timePer = (i/(sliderTimes.length-2))*100-6.4;
        var timeDir = "left";
      break;
      }
      $("#slidertimes").append("<span style='"+timeDir+": "+timePer+"%;' id='t"+sliderTimes[i]+"'>"+sliderTimes[i]+"</span>");
    }
    $('#checktime').change(function() {
      filterValues($("#slider").slider("value"));
      if($("#checktime").prop("checked")) {
        $("#playbutton").css("color","black");
      } else {
        $("#playbutton").css("color","silver");
        if(playid) clearInterval(playid);
      }
    });
    $('#playbutton').click(function () {
      if(!playing) {
        if($("#slider").slider("value")==lastYear) $("#slider").slider("value",1940)
        if($("#checktime").prop("checked")) {
          playid = setInterval(playAdvance, playinterval);
        }
        playing = true;
      } else {
        clearInterval(playid);
        playing = false;
      }

    });

});

function playAdvance() {
  if(playing)  {
    if($("#slider").slider("value")<lastYear) {
      $("#slider").slider("value",$("#slider").slider("value")+1);
      filterValues($("#slider").slider("value"));
    } else {
      clearInterval(playid);
      playing = false;
    }
  }
}

function filterValues(when) {
  if($("#checktime").prop("checked")) {
    svg.selectAll(".companies")
      .style("opacity",function(dd) {
      return filterStatus(when,dd.deployed,dd.retired,dd.type);
    })
  } else {
    svg.selectAll(".dot")
      .style("opacity",1)
  }
  $("#timeval").text(when);
}

function filterStatus(when,deployed,retired,type) {
  if(locked_type) {
    if(inArray(locked_type,type.split(","))) {
      if(deployed<=when) {
        if((retired>=when)||(!retired)) {
          return 1;
        } else {
          return .15;
        }
      } else {
        return 0;
      }
    } else {
      return 0;
    }
  } else {
    if(deployed<=when) {
      if((retired>=when)||(!retired)) {
        return 1;
      } else {
        return .15;
      }
    } else {
      return 0;
    }
  }
}

String.prototype.toTitleCase = function() {
  var i, j, str, lowers, uppers;
  str = this.replace(/([^\W_]+[^\s-]*) */g, function(txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });

  // Certain minor words should be left lowercase unless
  // they are the first or last words in the string
  lowers = ['A', 'An', 'The', 'And', 'But', 'Or', 'For', 'Nor', 'As', 'At',
  'By', 'For', 'From', 'In', 'Into', 'Near', 'Of', 'On', 'Onto', 'To', 'With'];
  for (i = 0, j = lowers.length; i < j; i++)
    str = str.replace(new RegExp('\\s' + lowers[i] + '\\s', 'g'),
      function(txt) {
        return txt.toLowerCase();
      });

  // Certain words such as initialisms or acronyms should be left uppercase
  uppers = ['Id', 'Tv','Ca'];
  for (i = 0, j = uppers.length; i < j; i++)
     str = str.replace(new RegExp('\\b' + uppers[i] + '\\b', 'g'),
       uppers[i].toUpperCase());

  return str;
}

</script>

<div id="timeaxis" style="position: relative;">
  <input type="checkbox" id="checktime"> Filter by year
  <span id="playbutton">&#9658;</span> <span id="timeval">1940</span>
  <div style="position: absolute; top: 0; right: 5%; width:80%;">
    <div style="" id="slider"></div>
    <div class="slidertimes" id="slidertimes"></div>
  </div>
</div>

<div id="options">
  <input type="checkbox" id="showsuperfund" checked> Show Superfund sites
  <input id="showcompanies" type="checkbox" checked> Show companies
  <input id="showresidential" type="checkbox" unchecked> Show residential overlay
  <input id="showindustrial" type="checkbox" unchecked> Show industrial overlay
  <input id="showboundaries" type="checkbox" unchecked> Show city boundaries
  <input id="showopenspace" type="checkbox" checked> Show open space
  <input id="showtypes" type="checkbox" unchecked> Color by industry type
  <input id="showlegend" type="checkbox" unchecked> Show legend
<br>
<br>
  Filter by: <select id="scale_option">
  <option value="no-filter" selected>No Filter</option>
  <option value="semi">Semiconductor manufacturers</option>
  <option value="hardware">Hardware manufacturers</option>
  <option value="hardware">Electronics</option>
  </select>

  Historical map overlay: <select id="scale_option">
  <option value="no-filter" selected>None</option>
  <option value="semi">Palo Alto 1953</option>
  <option value="hardware">San Jose 1956</option>
  <option value="hardware">Stanford 1954</option>
  </select>
</div>

<!-- <div id="filters">Filter by type: </div> -->

<div class="footer">
Created by <a href="http://jasonheppler.org">Jason A. Heppler</a>, University of Nebraska-Lincoln.
</div>

</body>
</html>

</body>
